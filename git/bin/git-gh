#!/usr/bin/env bash

set -euo pipefail

while getopts ':hc:t:' opt; do
  case "$opt" in
    h)
      read -r -d '' usage <<"USAGE" || true
%s [-c commit-ish] [-t commit-ish] [username/repo]

Opens the GitHub page for the current repository.

Options:
-c\tOpen commit page
-t\tOpen tree page
-h\tShow help
USAGE

      printf "$usage\\n" "${0##*/}"
      exit 0
      ;;

    c)
      path="/commit/$(git rev-parse "$OPTARG")"
      ;;

    t)
      path="/tree/$(git rev-parse "$OPTARG")"
      ;;

    '?')
      >&2 printf 'Invalid option: -%s\n' "$OPTARG"
      exit 1
      ;;

    :)
      >&2 printf 'Invalid option: -%s requires an argument\n' "$OPTARG"
      exit 1
      ;;
  esac
done

shift $((OPTIND - 1))

if [[ -z "${1:-}" ]]; then
  for url in $(git remote 2> /dev/null | xargs --max-args 1 git remote get-url --all 2> /dev/null); do
    case "$url" in
      https://github.com/*)
        repo="${url#https://github.com/}"
        ;;
      git@github.com:*)
        repo="${url#git@github.com:}"
        ;;
    esac

    [[ -v repo ]] && repo="${repo%.git}"
  done
fi

url=https://github.com/${repo:-${1?Need GitHub username/repo}}${path:-}

case "$OSTYPE" in
  cygwin)
    program=cygstart
    ;;

  darwin*)
    program=open
    ;;

  linux*)
    program=gnome-open
    ;;

  *)
    >&2 printf 'Unsupported platform: %s\n' "$OSTYPE"
    exit 1
    ;;
esac

"$program" "$url"
